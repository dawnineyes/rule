name: Update Geosite CN Rules

on:
  schedule:
    - cron: "0 0 * * *"        # 每天 UTC 0 点
  workflow_dispatch:

jobs:
  update-cn2:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download GeositeCN.yaml
        run: |
          curl -L "https://github.com/Accademia/Additional_Rule_For_Clash/raw/refs/heads/main/GeositeCN/GeositeCN.yaml" -o GeositeCN.yaml

      - name: Extract DOMAIN-SUFFIX and generate cn2.json
        run: |
          mkdir -p sing-box/geosite

          suffixes=$(grep -oP "(?<=DOMAIN-SUFFIX\s*,\s).*" GeositeCN.yaml | sed 's/ #.*//' | sed '/^\s*$/d')
          json_suffix=$(printf "%s\n" "$suffixes" | jq -R . | jq -s .)

          cat << 'EOF' > sing-box/geosite/cn2.json
{
  "version": 3,
  "rules": [
    {
      "domain_suffix": __JSON_DATA__
    }
  ]
}
EOF

          # 用安全的替换方式将 JSON 填充进去
          sed -i "s|__JSON_DATA__|$json_suffix|g" sing-box/geosite/cn2.json

      - name: Commit & Push if Changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep -q "cn2.json"; then
            git add sing-box/geosite/cn2.json
            git commit -m "Auto update cn2.json"
            git push
          else
            echo "No changes to commit"
