name: Update Geosite CN Rules

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-cn2:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download GeositeCN.yaml
        run: |
          curl -L "https://github.com/Accademia/Additional_Rule_For_Clash/raw/refs/heads/main/GeositeCN/GeositeCN.yaml" -o GeositeCN.yaml

      - name: Generate cn2.json (no jq)
        shell: bash
        run: |
          mkdir -p sing-box/geosite

          domains=()
          while IFS= read -r line; do
            # 提取 DOMAIN-SUFFIX 值
            d=$(echo "$line" | sed -n 's/.*DOMAIN-SUFFIX[[:space:]]*,[[:space:]]*\([^ #]*\).*/\1/p')
            if [[ -n "$d" ]]; then
              domains+=("\"$d\"")
            fi
          done < GeositeCN.yaml

          # 拼出 JSON 数组
          arr=$(printf ", %s" "${domains[@]}")
          arr="[${arr:2}]"

          # 写入文件
          echo "{
  \"version\": 3,
  \"rules\": [
    {
      \"domain_suffix\": $arr
    }
  ]
}" > sing-box/geosite/cn2.json

      - name: Commit & Push if Changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep -q "cn2.json"; then
            git add sing-box/geosite/cn2.json
            git commit -m "Auto update cn2.json"
            git push
          else
            echo "No changes to commit"
          fi
