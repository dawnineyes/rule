name: Sync GeoSite Lists

on:
  schedule:
    # 每天凌晨2点运行，可以根据需要调整时间
    - cron: '0 2 * * *'
  workflow_dispatch:
    # 允许手动触发工作流

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create Surge/geosite directory
      run: mkdir -p Surge/geosite

    - name: Get list of .list files
      id: get_files
      run: |
        # 使用curl获取文件列表，并过滤出.list文件
        # 注意：这里假设你可以直接访问该目录下的文件，或者你需要通过其他方式获取文件列表
        # 如果MetaCubeX/meta-rules-dat仓库设置了API访问限制，你可能需要调整此部分
        curl -s https://api.github.com/repos/MetaCubeX/meta-rules-dat/contents/meta/geo/geosite \
          | jq -r '.[] | select(.name | ends_with(".list")) | .download_url' \
          > .list_files.txt

    - name: Download and process .list files
      run: |
        while IFS= read -r url; do
          filename=$(basename "$url")
          echo "Downloading and processing $filename..."
          curl -s "$url" | sed 's/^+//g' > "Surge/geosite/$filename"
        done < .list_files.txt

    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Surge/geosite
        git diff-index --quiet HEAD || git commit -m "Sync geosite .list files"
        git push
