name: Update GeoIP2 CN CIDR

on:
  schedule:
    - cron: "0 0 * * *" # æ¯å¤©0ç‚¹UTCè¿è¡Œ (åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹)
  workflow_dispatch:

jobs:
  update-geoip:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸŒ Download IP list
        run: |
          curl -sSL https://raw.githubusercontent.com/Hackl0us/GeoIP2-CN/refs/heads/release/CN-ip-cidr.txt -o cn.txt
          if [ ! -s cn.txt ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥æˆ–å†…å®¹ä¸ºç©º"; exit 1;
          fi

      - name: ğŸ“ Generate geoip2-cn.json
        run: |
          mkdir -p sing-box/geoip
          {
            echo '{"version": 3,"rules":[{"ip_cidr":['
            sed 's/^/"/; s/$/"/' cn.txt | paste -sd, -
            echo ']}]}'
          } > sing-box/geoip/geoip2-cn.json

      - name: ğŸ” Commit & Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # åªæ·»åŠ ç›®æ ‡æ–‡ä»¶
          git add sing-box/geoip/geoip2-cn.json
          
          # å¦‚æœæœ‰å˜æ›´æ‰æäº¤
          if git diff --cached --quiet; then
            echo "ğŸŒŸ æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "Auto update GeoIP2 CN CIDR"
            git push
            echo "ğŸ“Œ å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
          fi
