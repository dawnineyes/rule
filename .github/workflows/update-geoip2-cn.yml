name: Update GeoIP2 CN CIDR

on:
  schedule:
    - cron: "0 0 * * *" # æ¯å¤©0ç‚¹UTCè¿è¡Œ (åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹)
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è¿è¡Œ

jobs:
  update-geoip:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç¡®ä¿å¯ä»¥æäº¤ä»£ç 

      - name: ğŸŒ Download IP list
        run: |
          curl -sSL https://raw.githubusercontent.com/Hackl0us/GeoIP2-CN/refs/heads/release/CN-ip-cidr.txt -o cn.txt
          if [ ! -s cn.txt ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi

      - name: ğŸ“ Generate geoip2-cn.json
        run: |
          echo '{"version": 3,"rules":[{"ip_cidr":[' > geoip2-cn.json
          sed 's/^/"/; s/$/"/' cn.txt | paste -sd, - >> geoip2-cn.json
          echo ']}]}' >> geoip2-cn.json

      - name: ğŸ“ Move file to target directory
        run: |
          mkdir -p sing-box/geoip
          mv geoip2-cn.json sing-box/geoip/geoip2-cn.json

      - name: ğŸ” Commit & Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sing-box/geoip/geoip2-cn.json
          git commit -m "Auto update GeoIP2 CN CIDR"
          git push
